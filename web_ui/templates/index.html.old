{% extends 'base.html' %}

{% block title %}Inicio — G1{% endblock %}

{% block content %}
<style>
  .main-content {
    padding-top: 8px;
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    color: #64748b;
  }

  .breadcrumb a {
    color: #64748b;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .breadcrumb a:hover {
    color: #667eea;
  }

  .breadcrumb .separator {
    color: #cbd5e1;
  }

  /* Page Header */
  .page-header {
    margin-bottom: 24px;
  }

  .page-title {
    font-size: 28px;
    font-weight: 500;
    color: #333;
    margin: 0;
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 16px;
  }

  .search-container {
    position: relative;
    flex-grow: 1;
    max-width: 400px;
  }

  .search-input {
    width: 100%;
    padding: 8px 36px 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
    color: #374151;
  }

  .search-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    pointer-events: none;
  }

  .action-group {
    display: flex;
    gap: 8px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
  }

  /* Create Button: Purple */
  .btn-create {
    background: #667eea;
    color: white;
    border: 1px solid #667eea;
  }

  .btn-create:hover {
    background: #5568d3;
    border-color: #5568d3;
    color: white;
  }

  /* Refresh Button */
  .btn-refresh {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .btn-refresh:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  /* Element Counter */
  .element-counter {
    background: #f3f4f6;
    padding: 10px 16px;
    border: 1px solid #e5e7eb;
    border-bottom: none;
    color: #4b5563;
    font-size: 14px;
  }

  /* Spinner Animation */
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .spinner {
    animation: spin 1s linear infinite;
  }

  /* Table */
  .table-container {
    background: white;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }

  .slices-table {
    width: 100%;
    border-collapse: collapse;
  }

  .slices-table th {
    background: #f3f4f6;
    padding: 12px 16px;
    text-align: left;
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
    border-bottom: 1px solid #e5e7eb;
  }

  .slices-table td {
    padding: 14px 16px;
    font-size: 14px;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
  }

  .slices-table tr:last-child td {
    border-bottom: none;
  }

  .slices-table tr:hover {
    background-color: #f9fafb;
  }

  .slice-name-link {
    color: #333;
    text-decoration: none;
    font-weight: 500;
  }

  .slice-name-link:hover {
    color: #667eea;
    text-decoration: underline;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
  }

  .status-badge.active {
    background: #d1fae5;
    color: #065f46;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #10b981;
  }

  .btn-delete-icon {
    background: none;
    border: none;
    color: #ef4444;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .btn-delete-icon:hover {
    background: #fee2e2;
  }

  .checkbox-col {
    width: 40px;
    text-align: center;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .empty-icon {
    margin-bottom: 16px;
    color: #9ca3af;
  }

  .empty-state h2 {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 8px 0;
  }

  .empty-state p {
    color: #6b7280;
    margin: 0 0 20px 0;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .modal-header {
    padding: 16px 24px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #9ca3af;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .modal-body {
    padding: 24px;
  }

  .modal-footer {
    padding: 16px 24px;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
  }

  .btn-secondary {
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
  }

  .btn-secondary:hover {
    background: #f3f4f6;
  }

  .btn-danger {
    background: #ef4444;
    border: 1px solid #ef4444;
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
    border-color: #dc2626;
  }
</style>

<!-- Breadcrumb -->
<div class="breadcrumb">
  <a href="#">Proyecto</a>
  <span class="separator">/</span>
  <span style="color: #9ca3af;">Inicio</span>
</div>

<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title">Slices desplegados</h1>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <div class="search-container">
    <input type="text" class="search-input" placeholder="Filtrar">
    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
  </div>
  <div class="action-group">
    <button id="refreshBtn" class="btn btn-refresh" title="Refrescar lista">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 4 23 10 17 10"></polyline>
        <polyline points="1 20 1 14 7 14"></polyline>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
      </svg>
    </button>
    <a href="{{ url_for('create_slice') }}" class="btn btn-create">
      <span style="font-weight:bold; font-size:16px;">+</span> Crear slice
    </a>
  </div>
</div>

<!-- Element Counter -->
<div class="element-counter" id="sliceCounter">Mostrando 0 elementos</div>

<!-- Loading State -->
<div id="loadingState" class="empty-state">
  <div class="empty-icon">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinner">
      <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
      <path d="M12 2 A10 10 0 0 1 22 12" stroke-linecap="round"></path>
    </svg>
  </div>
  <h2>Cargando slices...</h2>
  <p>Por favor espera un momento</p>
</div>

<!-- Table Container (inicialmente oculto) -->
<div id="tableContainer" class="table-container" style="display: none;">
  <table class="slices-table">
    <thead>
      <tr>
        <th class="checkbox-col"><input type="checkbox" id="selectAll"></th>
        <th>Nombre del Slice</th>
        <th>Creación</th>
        <th>Estado</th>
        <th style="text-align: right;">Acciones</th>
      </tr>
    </thead>
    <tbody id="slicesTableBody">
      <!-- Rows will be populated via JavaScript -->
    </tbody>
  </table>
</div>

<!-- Bottom Counter (inicialmente oculto) -->
<div id="bottomCounter" class="element-counter" style="display: none; border-top: none; border-bottom: 1px solid #e5e7eb;">
  Mostrando 0 elementos
</div>

<!-- Empty State (inicialmente oculto) -->
<div id="emptyState" class="empty-state" style="display: none;">
  <div class="empty-icon">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="3" y="3" width="7" height="7" rx="1"></rect>
      <rect x="14" y="3" width="7" height="7" rx="1"></rect>
      <rect x="14" y="14" width="7" height="7" rx="1"></rect>
      <rect x="3" y="14" width="7" height="7" rx="1"></rect>
    </svg>
  </div>
  <h2>No hay slices activos</h2>
  <p>Comienza creando tu primer slice de red</p>
  <a class="btn btn-create" href="{{ url_for('create_slice') }}">
    <span style="font-weight:bold; font-size:16px;">+</span> Crear primer slice
  </a>
</div>

<!-- Modal de confirmación de eliminación -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Confirmar eliminación</h3>
      <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div style="text-align: center; margin-bottom: 20px;">
        <div
          style="width: 60px; height: 60px; margin: 0 auto 16px; border-radius: 50%; background: #fee2e2; display: flex; align-items: center; justify-content: center;">
          <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
        </div>
        <p style="font-size: 16px; font-weight: 600; color: #1e293b; margin: 0 0 8px 0;">¿Está seguro que desea borrar
          el Slice?</p>
        <p style="font-size: 14px; color: #64748b; margin: 0;" id="sliceNameToDelete"></p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  loadSlices();
});

function loadSlices() {
  document.getElementById('loadingState').style.display = 'block';
  document.getElementById('tableContainer').style.display = 'none';
  document.getElementById('bottomCounter').style.display = 'none';
  document.getElementById('emptyState').style.display = 'none';

    fetch('/api/slices/list', {
      method: 'GET',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json'
      }
    })
      .then(response => {
        // Check if redirected to login (Flask redirect)
        if (response.redirected && response.url.includes('/login')) {
          window.location.href = '/login';
          return null;
        }
        
        if (response.status === 401 || response.status === 302) {
          window.location.href = '/login';
          return null;
        }
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.json();
      })
      .then(data => {
        if (!data) return; // Session expired or redirecting

        document.getElementById('loadingState').style.display = 'none';

        if (data.success && data.slices && data.slices.length > 0) {
          // Show table with slices
          populateSlicesTable(data.slices);
          document.getElementById('sliceCounter').textContent = `Mostrando ${data.total_slices} elementos`;
          document.getElementById('bottomCounter').textContent = `Mostrando ${data.total_slices} elementos`;
          document.getElementById('tableContainer').style.display = 'block';
          document.getElementById('bottomCounter').style.display = 'block';
        } else {
          // Show empty state
          document.getElementById('sliceCounter').textContent = 'Mostrando 0 elementos';
          document.getElementById('emptyState').style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Error loading slices:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        
        // Show error message
        const emptyState = document.getElementById('emptyState');
        emptyState.innerHTML = `
          <div class="empty-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <h2>Error al cargar slices</h2>
          <p>${error.message || 'Hubo un problema al conectar con el servidor'}</p>
          <button class="btn btn-refresh" onclick="loadSlices()">Reintentar</button>
        `;
      });
  }

  function populateSlicesTable(slices) {
    const tbody = document.getElementById('slicesTableBody');
    tbody.innerHTML = ''; // Clear existing rows

    slices.forEach(slice => {
      const row = document.createElement('tr');
      
      // Format timestamp
      let formattedDate = 'N/A';
      if (slice.timestamp_creacion) {
        const date = new Date(slice.timestamp_creacion);
        formattedDate = date.toLocaleString('es-ES', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Map estado to Spanish
      const estadoMap = {
        'corriendo': 'Corriendo',
        'detenido': 'Detenido',
        'error': 'Error',
        'creando': 'Creando'
      };
      const estadoText = estadoMap[slice.estado] || slice.estado;

      row.innerHTML = `
        <td class="checkbox-col"><input type="checkbox" class="slice-checkbox" data-slice-id="${slice.id}"></td>
        <td>
          <a href="/slice/${slice.id}" class="slice-name-link">${slice.nombre_slice}</a>
        </td>
        <td>${formattedDate}</td>
        <td>
          <span class="status-badge active">
            <span class="status-dot"></span>
            ${estadoText}
          </span>
        </td>
        <td style="text-align: right;">
          <button class="btn-delete-icon" title="Eliminar" onclick="showDeleteModal(${slice.id})">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
    });

    // Setup checkbox event listeners and search
    setupCheckboxListeners();
    setupSearch();
  }

  function setupCheckboxListeners() {
    const selectAll = document.getElementById('selectAll');
    if (selectAll) {
      selectAll.addEventListener('change', function () {
        const boxes = document.querySelectorAll('.slice-checkbox');
        boxes.forEach(cb => { cb.checked = this.checked; });
      });

      const updateHeaderCheckbox = () => {
        const boxes = document.querySelectorAll('.slice-checkbox');
        if (boxes.length === 0) return;
        selectAll.checked = Array.from(boxes).every(b => b.checked);
      };

      document.querySelectorAll('.slice-checkbox').forEach(cb => {
        cb.addEventListener('change', updateHeaderCheckbox);
      });
    }
  }

  // Search functionality
  function setupSearch() {
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
      searchInput.addEventListener('input', function () {
        const term = this.value.toLowerCase();
        const rows = document.querySelectorAll('.slices-table tbody tr');

        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(term) ? '' : 'none';
        });
      });
    }
  }

  let sliceToDelete = null;

  function showDeleteModal(sliceId) {
    sliceToDelete = sliceId;
    document.getElementById('sliceNameToDelete').textContent = `Slice #${sliceId}`;
    document.getElementById('deleteModal').style.display = 'flex';
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    sliceToDelete = null;
  }

  function confirmDelete() {
    if (sliceToDelete) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/delete/' + sliceToDelete;
      document.body.appendChild(form);
      form.submit();
    }
  }

  // Cerrar modal al hacer clic fuera
  const deleteModal = document.getElementById('deleteModal');
  if (deleteModal) {
    deleteModal.addEventListener('click', function (e) {
      if (e.target === this) {
        closeDeleteModal();
      }
    });
  }
</script>
<!-- Cache buster: v1.0.1 -->
{% endblock %}